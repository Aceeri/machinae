<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>machinae</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <base href="">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="_FontAwesome/css/font-awesome.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        

    </head>
    <body class="light">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="machinae.html">Introduction</a></li><li><a href="01_state.html"><strong aria-hidden="true">1.</strong> Implementing State</a></li><li><ol class="section"><li><a href="01_state/01_enum.html"><strong aria-hidden="true">1.1.</strong> For an enum</a></li><li><a href="01_state/02_dyn.html"><strong aria-hidden="true">1.2.</strong> Multiple types</a></li><li><a href="01_state/03_ref.html"><strong aria-hidden="true">1.3.</strong> Taking a reference</a></li></ol></li><li><a href="02_methods.html"><strong aria-hidden="true">2.</strong> State methods and transitions</a></li><li><a href="03_non_game_dev.html"><strong aria-hidden="true">3.</strong> machinae outside of game dev</a></li><li><a href="04_trouble.html"><strong aria-hidden="true">4.</strong> Troubleshooting</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">machinae</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="print.html#machinae" id="machinae"><h1>machinae</h1></a>
<p>This is the documentation for <a href="https://github.com/rustgd/machinae">machinae</a>, a generic state machine
intended to be primarily used in game development.</p>
<p>In addition to this book you can find a list of the items in
the <a href="https://docs.rs/machinae">API documentation</a>.</p>
<p>You'll mostly need the types <code>StateMachine</code>, <code>State</code> and <code>Trans</code>.
The state machine stores a stack of states and updates that stack
according to the <code>Trans</code>itions returned by the current state.</p>
<a class="header" href="print.html#book-structure" id="book-structure"><h2>Book structure</h2></a>
<p>This book is split into five chapters, this being the introduction. After this chapter:</p>
<ul>
<li><a href="./01_state.html">Implementing State</a></li>
<li><a href="./02_methods.html">State methods and transitions</a></li>
<li><a href="./03_non_game_dev.html">Using machinae outside of game development</a></li>
<li><a href="./04_trouble.html">Troubleshooting</a></li>
</ul>
<a class="header" href="print.html#example-code" id="example-code"><h2>Example code</h2></a>
<pre><pre class="playpen"><code class="language-rust">extern crate machinae;

use machinae::*;

#[derive(Debug)]
struct Error;

enum Event {
    WindowQuit,
    KeyPress(char),
}

struct Game {
    // ..
}

enum GameState {
    Loading,
    MainMenu,
    InGame,
}

impl&lt;'a&gt; State&lt;&amp;'a mut Game, Error, Event&gt; for GameState {
    fn start(&amp;mut self, args: &amp;mut Game) -&gt; Result&lt;Trans&lt;Self&gt;, Error&gt; {
        match *self {
            GameState::Loading =&gt; {
                args.load(&quot;buttons&quot;);
                args.load(&quot;player&quot;);
                
                Trans::None
            }
            GameState::MainMenu =&gt; {}
            GameState::InGame =&gt; {
                if !args.login() {
                    Trans::None
                } else {
                    eprintln!(&quot;Login failed&quot;);
                                        
                    Trans::Pop
                }
            }
        }
    }

    // all methods have a default no-op implementation,
    // so you can also leave them out
    fn resume(&amp;mut self, _: &amp;mut Game) {}

    fn pause(&amp;mut self, _: &amp;mut Game) {}

    fn stop(&amp;mut self, args: &amp;mut Game) {
        match *self {
            GameState::Loading =&gt; {}
            GameState::MainMenu =&gt; {}
            GameState::InGame =&gt; args.logout(),
        }
    }

    fn update(&amp;mut self, args: &amp;mut Game) -&gt; Result&lt;Trans&lt;Self&gt;, Error&gt; {
        match *self {
            GameState::Loading =&gt; {
                let progress = args.progress();
                args.draw_bar(progress);
                
                if progress == 1.0 {
                    Trans::Switch(GameState::MainMenu)
                } else {
                    Trans::None
                }
            }
            GameState::MainMenu =&gt; {
                if args.button(&quot;start_game&quot;) {
                    Trans::Push(GameState::InGame)
                } else {
                    Trans::None
                }
            }
            GameState::InGame =&gt; {
                args.draw(&quot;player&quot;);
                
                if args.is_alive(&quot;player&quot;) {
                    Trans::None
                } else {
                    // Don't let the user rage quit
                    Trans::Quit
                }
            },
        }
    }

    fn fixed_update(&amp;mut self, args: &amp;mut Game) -&gt; Result&lt;Trans&lt;Self&gt;, Error&gt; {
        match *self {
            GameState::Loading =&gt; {}
            GameState::MainMenu =&gt; {}
            GameState::InGame =&gt; args.do_physics(),
        }
    }

    fn event(&amp;mut self, args: &amp;mut Game, event: Event) -&gt; Result&lt;Trans&lt;Self&gt;, Error&gt; {
        match event {
            Event::KeyPress('w') =&gt; args.translate(&quot;player&quot;, 3.0, 0.0),
            Event::KeyPress('q') =&gt; Trans::Quit,
            Event::WindowQuit =&gt; Trans::Quit,
        }
    }
}

fn run() -&gt; Result&lt;(), Error&gt; {
    use std::time::{Duration, Instant};

    let mut machine = StateMachineRef::new(GameState::Loading);

    let mut game = Game { /*..*/ };

    machine.start(&amp;mut game)?;
    machine.fixed_update(&amp;mut game)?;
    
    let mut last_fixed = Instant::now();
    
    while machine.running() {
        for event in window.poll_events() {
            machine.event(&amp;mut game, event)?;
        }        
    
        if last_fixed.elapsed().subsec_nanos() &gt; 4_000_000 {
            machine.fixed_update(&amp;mut game)?;
        }
    
        machine.update(&amp;mut game)?;
    }

    Ok(())
}

fn main() {
    if let Err(e) = run() {
        eprintln!(&quot;Error occurred: {:?}&quot;, e);
    }
}
</code></pre></pre>
<a class="header" href="print.html#implementing-state" id="implementing-state"><h1>Implementing <code>State</code></h1></a>
<p>This chapter explains how you implement the states.
For the state lifecycle see the <a href="./02_methods.html">second chapter</a>.</p>
<p><code>machinae</code> is designed to be as lightweight as possible.
To achieve that, the <code>State</code>s in the state machine are strongly
typed (in lieu of using trait objects). That means that your
state is likely to be an enum. However, for some scenarios you
need many different states; that can get quite confusing if
you have to <code>match</code> your enum in every method. Because of that,
there's a second way to work with this crate: you just create multiple
structs and implement <code>DynState</code> for each struct. Every <code>Box&lt;DynState&gt;</code>
has an implementation for <code>State</code> automatically.</p>
<ul>
<li><a href="./01_state/01_enum.html">Use an enum for your <code>State</code></a></li>
<li><a href="./01_state/02_dyn.html">Check out <code>DynState</code> instead</a></li>
</ul>
<a class="header" href="print.html#working-with-references" id="working-with-references"><h2>Working with references</h2></a>
<p>In case your argument to the states is a reference, there are
some things you need pay attention to. <a href="./01_state/03_ref.html">Chapter 1.3</a> describes
how to do that.</p>
<a class="header" href="print.html#implementing-state-for-an-enum" id="implementing-state-for-an-enum"><h1>Implementing <code>State</code> for an enum</h1></a>
<p>This is probably the most straightforward way of creating
states. First, you create an enum with all your states:</p>
<pre><code class="language-rust ignore">pub enum MyState {
    State1,
    State2,
    State3,
    StateWithData(String),
}
</code></pre>
<p>Next, you need to import your argument, error and event types:</p>
<pre><code class="language-rust ignore">use some_module::{Argument, Event, Error};
</code></pre>
<p>And then you can finally implement <code>State</code>:</p>
<pre><code class="language-rust ignore">use machinae::{State, Trans};

impl State&lt;Argument, Error, Event&gt; for MyState {}
</code></pre>
<p>Then, you'll have to match the enum in every method:</p>
<pre><code class="language-rust ignore">fn start(&amp;mut self, arg: Argument) -&gt; Result&lt;Trans&lt;Self&gt;, Error&gt; {
    match *self {
        State1 =&gt; Trans::None,
        State2 =&gt; Trans::None,
        State3 =&gt; Trans::None,
        StateWithData(_) =&gt; Trans::None,
    }
}
</code></pre>
<a class="header" href="print.html#implementing-state-for-multiple-types" id="implementing-state-for-multiple-types"><h1>Implementing <code>State</code> for multiple types</h1></a>
<p>This chapter describes how to work with machinae
if you want to use trait objects for your states.
This allows you to better organize the states using multiple
types, but it's not as efficient since it uses dynamic dispatch
and allocates on the heap.</p>
<p>You'll need to import the following machinae types,
plus your argument, error and event types:</p>
<pre><code class="language-rust ignore">use machinae::{DynMachine, DynResult, DynState, Trans};
use some_module::{Argument, Error, Event};
</code></pre>
<p>Next, define the structs you want to use as states:</p>
<pre><code class="language-rust ignore">struct State1;

struct State2(i32);
</code></pre>
<p>Because we're not using a single type here, we can't
use <code>State</code> directly, but rather implement <code>DynState</code>
for every struct. A boxed <code>DynState</code> automatically implements
<code>State</code>.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
impl DynState&lt;Argument, Error, Event&gt; for State1 {
    fn start(&amp;mut self, args: Argument) -&gt; DynResult&lt;i32, Error, Event&gt; {
        Ok(Trans::None)
    }

    fn update(&amp;mut self, args: Argument) -&gt; DynResult&lt;i32, Error, Event&gt; {
        Ok(Trans::Switch(Box::new(State2(42))))
    }
}

impl DynState&lt;i32, Error, Event&gt; for State2 {
    fn start(&amp;mut self, args: Argument) -&gt; DynResult&lt;i32, Error, Event&gt; {
        Ok(Trans::Quit)
    }
}
#}</code></pre></pre>
<p>And finally you can use the <code>DynMachine</code> typedef to
create a new state machine:</p>
<pre><code class="language-rust ignore">let mut machine = DynMachine::new(Box::new(State1));
</code></pre>
<a class="header" href="print.html#taking-a-reference-as-parameter" id="taking-a-reference-as-parameter"><h1>Taking a reference as parameter</h1></a>
<p>If you're taking a reference as parameter,
you can mostly follow <a href="./01_state/01_enum.html">chapter 1.1</a> or <a href="./01_state/02_dyn.html">chapter 1.2</a>,
however with one little exception:</p>
<p>Your implementation for <code>State</code> needs to work with every possible
lifetime <code>'a</code>. So it has to look like that:</p>
<pre><code class="language-rust ignore">impl&lt;'a&gt; State&lt;&amp;'a Argument, Error, Event&gt; for MyState {}
</code></pre>
<p>It is very important that <code>'a</code> is not bound on anything.
If your state has a lifetime <code>'b</code>, you have to declare
two lifetimes for the <code>State</code> implementation, otherwise
a given <code>MyState&lt;'a&gt;</code> would only implement <code>State&lt;'a&gt;</code>
(but it has to implement <code>State</code> for every possible
lifetime which Rust expresses with <code>for&lt;'a&gt; State&lt;'a&gt;</code>).</p>
<a class="header" href="print.html#state-methods-and-transitions" id="state-methods-and-transitions"><h1>State methods and transitions</h1></a>
<p>[TODO]</p>
<a class="header" href="print.html#using-machinae-outside-of-game-development" id="using-machinae-outside-of-game-development"><h1>Using machinae outside of game development</h1></a>
<p>[TODO]</p>
<a class="header" href="print.html#troubleshooting" id="troubleshooting"><h1>Troubleshooting</h1></a>
<p>[TODO]</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() {
                window.print();
            })
        </script>
        

        

        
        <script src="searchindex.js" type="text/javascript" charset="utf-8"></script>
        
        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

    </body>
</html>
